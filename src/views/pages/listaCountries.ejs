<div class="container my-4">
    <!-- T√≠tulo -->
    <h3 class="fw-bold text-primary mb-3">üåé Listado de Pa√≠ses</h3>

    <!-- Fila para b√∫squeda y botones -->
    <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap">
      <!-- boton de busqueda -->
        <div class="input-group w-auto mb-2" style="max-width: 400px;">
    <span class="input-group-text bg-white border border-primary"><i class="bi bi-search"></i></span>
    <input type="text" id="filtroPais" class="form-control border border-primary" placeholder="Ingrese el nombre ">
        </div>

        <!-- Botones -->
        <div class="d-flex gap-2 mb-2 flex-wrap justify-content-end">
            <a href="/countries/guardarPaises" class="btn btn-success shadow-sm">
                <i class="bi bi-plus-circle"></i> Obtener Pa√≠ses
            </a>
            <a href="/countries/confirmar" class="btn btn-danger shadow-sm">
                <i class="bi bi-trash"></i> Eliminar Pa√≠ses
            </a>
        </div>
    </div>

    <!-- Tabla de pa√≠ses -->
    <div class="table-responsive shadow rounded">
        <table class="table table-hover align-middle text-center" id="tablaPaises">
            <thead class="table-primary">
                <tr>
                    <th>Nombre</th>
                    <th>Capital</th>
                    <th>√Årea</th>
                    <th>Poblaci√≥n</th>
                    <th>Fronteras</th>
                    <th>Zona Horaria</th>
                    <th>Indice Gini</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                <% if (countries.length > 0) { %>
                    <% countries.forEach(element => { %>
                        <tr>
                            <td class="fw-semibold"> <%= element.name.official %></td>
                            <td><%= element.capital %></td>
                            <td><%= element.area.toLocaleString() %> km¬≤</td>
                            <td><%= element.population.toLocaleString() %></td>
                            <td>
                                <% if (element.borders && element.borders.length > 0) { %>
                                    <%= element.borders.join(', ') %>
                                <% } else { %>
                                    <span class="text-muted">Sin fronteras</span>
                                <% } %>
                            </td>
                            <td><%= element.timezones.join(', ') %></td>

                            <% 
                                let giniData = null;
                                if (element.gini && element.gini instanceof Map && element.gini.size > 0) {
                                    const giniArray = Array.from(element.gini.entries());
                                    const validEntries = giniArray.filter(([year, value]) => !isNaN(parseInt(year)) && value != null && !isNaN(value));
                                    if (validEntries.length > 0) {
                                        const sortedEntries = validEntries.sort(([a],[b]) => parseInt(b)-parseInt(a));
                                        const [latestYear, latestValue] = sortedEntries[0];
                                        giniData = { year: latestYear, value: latestValue };
                                    }
                                } else if (element.gini && typeof element.gini === 'object' && !(element.gini instanceof Map)) {
                                    const keys = Object.keys(element.gini).filter(year => !isNaN(parseInt(year)) && element.gini[year] != null && !isNaN(element.gini[year]));
                                    if (keys.length > 0) {
                                        const latestYear = Math.max(...keys.map(k => parseInt(k)));
                                        giniData = { year: latestYear, value: element.gini[latestYear] };
                                    }
                                }
                            %>
                            <td>
                                <% if (giniData) { %>
                                    <%= giniData.value.toFixed(1) %> (A√±o: <%= giniData.year %>)
                                <% } else { %>
                                    <span class="text-muted">Sin datos</span>
                                <% } %>
                            </td>

                            <td>
                                <div class="d-flex justify-content-center gap-2">
                                    <a href="/countries/editar/<%= element._id %>" class="btn btn-sm btn-warning shadow-sm">
                                        <i class="bi bi-pencil"></i> Editar
                                    </a>
                                    <form action="/countries/eliminar/<%= element._id %>?_method=DELETE" method="post">
                                        <button type="submit" class="btn btn-sm btn-danger shadow-sm" onclick="return confirm('¬øSeguro que deseas eliminar <%= element.name.official %>?')">
                                            <i class="bi bi-trash"></i> Eliminar
                                        </button>
                                    </form>
                                </div>
                            </td>
                        </tr>
                    <% }) %>
                <% } else { %>
                    <tr>
                        <td colspan="12" class="text-center text-muted py-3">
                            <i class="bi bi-exclamation-circle"></i> ¬°No hay paises disponibles!
                        </td>
                    </tr>
                <% } %>
            </tbody>
        </table>
    </div>

    <h3 class="fw-bold text-primary mb-3 my-3"> <i class="bi bi-bar-chart-line me-2"></i> Estad√≠sticas</h3>

    <!-- Tabla de estad√≠sticas -->
    <div class="table-responsive shadow rounded mt-4">
        <table class="table table-hover align-middle text-center">
            <thead class="table-primary">
                <tr>
                    <th>Poblaci√≥n</th>
                    <th>√Årea</th>
                    <th>Promedio Gini</th>
                </tr>
            </thead>
            <tbody>
                    <% if(estadisticas.totalPoblacion && estadisticas.totalArea && estadisticas.totalPromediosGini) { %>
                <tr> 
                    <td><%= estadisticas.totalPoblacion.toLocaleString() %></td>
                    <td><%= estadisticas.totalArea.toLocaleString() %></td>
                    <td><%= estadisticas.totalPromediosGini.toFixed(2) %></td>                    
                </tr>
            <% } else { %>
                <tr>
                <td colspan="12" class="text-center text-muted py-3">
                            <i class="bi bi-exclamation-circle"></i> ¬°No hay estadisticas disponibles!
                </td>
                </tr>
            <% } %>
            </tbody>
        </table>
    </div>
</div>

<script src="/js/filtroTablaPaises.js"> </script>
